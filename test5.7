using System;
using System.Collections.Generic;
using System.Threading;

namespace School
{
    internal class Program
    {
        static void Main(string[] args)
        {
            Console.ForegroundColor = ConsoleColor.White;
            Console.WindowHeight = 50;
            Console.WindowWidth = 180;

            Arena arena = new Arena();

            bool isGameActive = true;

            while (isGameActive)
            {
                Console.Clear();

                Console.WriteLine("To start Game press -- 1");
                Console.WriteLine("To exit press -- 2");

                string userInput = Console.ReadLine();

                if (userInput == "1")
                {
                    Console.Clear();
                    arena.DisplayMainInformation();
                }
                else if (userInput == "2")
                {
                    isGameActive = false;
                }
            }
        }
    }

    class Arena
    {
        private List<Fighter> _fighters = new List<Fighter>();
        private List<Fighter> _preaperingFighters = new List<Fighter>();

        private Dictionary<int, string> _description = new Dictionary<int, string>();

        public Arena()
        {
            AddFighters();
            AddDecription();
        }

        public void DisplayMainInformation()
        {
            int oneSecond = 1000;

            while (_preaperingFighters.Count != 2)
            {
                DisplayFighters();


                if (TrySelectFighter(out Fighter fighter))
                {
                    _preaperingFighters.Add(fighter.Clone());
                    Console.Clear();
                }
                else
                {
                    Console.WriteLine("Fighter not found!");
                    Thread.Sleep(oneSecond);
                    Console.Clear();
                }
            }

            Fight(_preaperingFighters[0], _preaperingFighters[1]);

            Console.ReadLine();
        }

        private bool TrySelectFighter(out Fighter fighter)
        {
            int index;

            Console.Write("Select the fighters: ");

            if (int.TryParse(Console.ReadLine(), out index))
            {
                index -= 1;
                if (index < _fighters.Count)
                {
                    fighter = _fighters[index];
                    return fighter != null;
                }
                else
                {
                    fighter = null;
                    return false;
                }
            }
            else
            {
                fighter = null;
                return false;
            }
        }

        private void AddDecription()
        {
            _description.Add(0, "This fighter does not possess great strength, but he knows how to use healing magic, replenishing his health by 5 points after each attack.");
            _description.Add(1, "This fighter's fury awakens when his health level falls below 75, and he can deliver a super blow while defending against the opponent. But only once!");
            _description.Add(2, "This fighter is quite proficient with a shield, and there is a high probability that he will be able to fend off the opponent's attack.");
            _description.Add(3, "This fighter deflects every third attack completely!");
            _description.Add(4, "Every fourth attack of this fighter will be very powerful! A whopping 25 points!");
        }

        private void AddFighters()
        {
            _fighters.Add(new StormRaider("Storm Raider", 150, 25));
            _fighters.Add(new InfernoWarrior("Inferno Warrior", 150, 25));
            _fighters.Add(new GlacialKinght("Glacial Kinght", 150, 25));
            _fighters.Add(new TerraGuardian("Terra Guardian", 150, 25));
            _fighters.Add(new KamehamehaWarrior("Kamehameha Warrior", 150, 25));
        }

        private void DisplayFighters()
        {
            for (int i = 0; i < _fighters.Count; i++)
            {
                Console.WriteLine($"Fighter name - {_fighters[i].GetName} | Fighter's health - {_fighters[i].GetHealth} | Attack power - {_fighters[i].GetPower}");
                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine($"{_description[i]}\n");
                Console.ForegroundColor = ConsoleColor.White;
            }
            RenderLine();
        }

        private void ShowStats(Fighter fighterOne, Fighter fighterTwo)
        {
            Console.WriteLine($"Fighter Two - / {fighterOne.GetName}/ health {fighterOne.GetHealth}|| Fighter Two - / {fighterTwo.GetName}/ health {fighterTwo.GetHealth}");
        }

        private void Fight(Fighter fighterOne, Fighter fighterTwo)
        {
            bool isFightActive = true;

            while (isFightActive)
            {
                fighterOne.TakeDamage(fighterTwo.Attack());
                fighterTwo.TakeDamage(fighterOne.Attack());
                _preaperingFighters.Clear();

                ShowStats(fighterOne, fighterTwo);
                Thread.Sleep(500);

                if (fighterOne.GetHealth == 0 && fighterTwo.GetHealth == 0)
                {
                    Console.WriteLine("Draw");

                    isFightActive = false;
                }
                else if (fighterTwo.GetHealth == 0)
                {
                    Console.ForegroundColor = ConsoleColor.Red;
                    Console.WriteLine($"Winner is {fighterOne.GetName}");
                    Console.ForegroundColor = ConsoleColor.White;

                    isFightActive = false;
                }
                else if (fighterOne.GetHealth == 0)
                {
                    Console.ForegroundColor = ConsoleColor.Red;
                    Console.WriteLine($"Winner is {fighterTwo.GetName}");
                    Console.ForegroundColor = ConsoleColor.White;

                    isFightActive = false;
                }
            }
        }

        private void RenderLine()
        {
            Console.WriteLine("\n**" + new string('-', 75) + "**\n");
        }
    }

    abstract class Fighter
    {
        public Fighter(string name, int health, int power)
        {
            Health = health;
            Name = name;
            Power = power;

        }
        protected int Power;
        protected string Name;
        protected int Health;

        public int GetHealth
        {
            get { return Health; }
        }

        public int GetPower
        {
            get { return Power; }
        }

        public string GetName
        {
            get { return Name; }
        }

        public Fighter Clone()
        {
            return (Fighter)MemberwiseClone();
        }

        public abstract void TakeDamage(int damage);

        public abstract int Attack();
    }

    class StormRaider : Fighter
    {
        public StormRaider(string name, int health, int power) : base(name, health, power)
        {
        }

        public override void TakeDamage(int damage)
        {
            Health -= damage - 5;

            if (Health < 0)
            {
                Health = 0;
            }
        }

        public override int Attack()
        {
            return Power;
        }
    }

    class InfernoWarrior : Fighter
    {
        public InfernoWarrior(string name, int health, int power) : base(name, health, power)
        {
        }

        private int _countAttack = 0;

        public override void TakeDamage(int damage)
        {
            if (Health < 75 && _countAttack < 1)
            {
                damage = 0;
            }
            Health -= damage;

            if (Health < 0)
            {
                Health = 0;
            }
        }

        public override int Attack()
        {
            int bonusPower = 45;

            if (Health < 75 && _countAttack < 1)
            {
                _countAttack++;
                return Power + bonusPower;
            }
            else
            {
                return Power;
            }
        }
    }

    class GlacialKinght : Fighter
    {
        public GlacialKinght(string name, int health, int power) : base(name, health, power)
        {
        }

        private Random _random = new Random();

        public override void TakeDamage(int damage)
        {
            int maxSafeNumber = 5;
            int minSafeNumber = 1;
            int safeNumber;
            int defendAttack;

            defendAttack = _random.Next(minSafeNumber, maxSafeNumber);
            safeNumber = _random.Next(minSafeNumber, maxSafeNumber);

            if (defendAttack != safeNumber)
            {
                Health -= Power;
            }

            if (Health < 0)
            {
                Health = 0;
            }
        }

        public override int Attack()
        {
            return Power;
        }
    }

    class TerraGuardian : Fighter
    {
        public TerraGuardian(string name, int health, int power) : base(name, health, power)
        {
        }

        private int _damageCount = 0;

        public override void TakeDamage(int damage)
        {
            int healthSave = 10;
            _damageCount++;

            if (_damageCount < 3)
            {
                Health -= damage;
            }
            else
            {
                Health -= (damage - healthSave);
            }

            if (Health < 0)
            {
                Health = 0;
            }
        }

        public override int Attack()
        {
            return Power;
        }
    }

    class KamehamehaWarrior : Fighter
    {
        public KamehamehaWarrior(string name, int health, int power) : base(name, health, power)
        {
        }

        private int _attackCount = 0;

        public override void TakeDamage(int damage)
        {
            Health -= damage;

            if (Health < 0)
            {
                Health = 0;
            }
        }

        public override int Attack()
        {
            int bonusPower = 25;

            _attackCount++;

            if (_attackCount < 4)
            {
                return Power;
            }
            else
            {
                _attackCount = 0;
                return Power + bonusPower;
            }
        }
    }
}
